

// src/index.ts
export default {
  async fetch(request) {
    try {
      const url = new URL(request.url);
      const path = url.pathname;
      
      // Log the incoming request URL
      console.log(`Incoming request URL: ${request.url}`);

      // Handle /stats/ paths and remove '/stats' from the path for redirection
      if (path.startsWith("/stats/")) {
        const newPath = path.replace(/^\/stats/, ''); // Remove "/stats" from the URL
        const targetUrl2 = `https://stats.magmatranslation.com${newPath}`;
        console.log(`Redirecting to: ${targetUrl2}`);
        return fetch(targetUrl2);
      }

      // Handle font requests and proxy to the appropriate font server
      if (path.startsWith("/fonts/")) {
        const targetUrl2 = `https://affectionate-hands-482523.framer.app${path}`;
        const fontResponse = await fetch(targetUrl2);
        if (fontResponse.status === 200) {
          const fontData = await fontResponse.arrayBuffer();
          const ext = path.split(".").pop();
          const contentType2 = {
            woff: "font/woff",
            woff2: "font/woff2",
            ttf: "font/ttf",
            otf: "font/otf"
          }[ext] || "application/octet-stream";
          return new Response(fontData, {
            headers: {
              "Content-Type": contentType2,
              "Access-Control-Allow-Origin": "*",
              "Access-Control-Allow-Methods": "GET, HEAD, OPTIONS",
              "Access-Control-Allow-Headers": "Content-Type"
            }
          });
        } else {
          return new Response("Font not found", { status: 404 });
        }
      }

      // Handle other requests and proxy them to the Framer app
      const targetUrl = `https://affectionate-hands-482523.framer.app${path}`;
      let response = await fetch(targetUrl);
      const contentType = response.headers.get("Content-Type") || "";

      // Log the content type of the response
      console.log(`Response Content-Type: ${contentType}`);

      // Modify only HTML responses
      if (contentType.includes("text/html")) {
        let text = await response.text();
        
        // Log the HTML content before modification (useful for debugging)
        console.log("HTML content retrieved, modifying it...");

        // Replace font URLs if necessary
        text = text.replace(/https:\/\/www\.framer\.com\/fonts\//g, "/fonts/");

        // Hide Framer badge by injecting a custom style
        const cssToHideBadge = `<style>#__framer-badge-container { display: none !important; }</style>`;
        text = text.replace("</head>", `${cssToHideBadge}</head>`);

        // Inject the canonical link tag
        const canonicalUrl = `https://magmatranslation.com${path}`;
        const canonicalLinkTag = `<link rel="canonical" href="${canonicalUrl}" />`;
        text = text.replace("</head>", `${canonicalLinkTag}</head>`);

        // Log the canonical URL being injected
        console.log(`Canonical link injected: ${canonicalUrl}`);

        // Return the modified HTML response
        return new Response(text, {
          headers: {
            "Content-Type": "text/html"
          }
        });
      } else {
        // For non-HTML responses, return them as-is
        console.log(`Non-HTML content, returning as is: ${contentType}`);
        return response;
      }
    } catch (e) {
      // Log the error message for debugging
      console.error(`Error occurred: ${e.message}`);
      return new Response("An error occurred: " + e.message, { status: 500 });
    }
  }
};
